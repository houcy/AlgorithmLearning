# STP

注意: 本文大量参考网络资料<br>
[相关资料1](https://blog.csdn.net/kaoa000/article/details/8991716)<br>
[相关资料2](https://www.cnblogs.com/findumars/p/8412013.html)

## 简介

STP是生成树协议(Spanning Tree Protocol)的英文缩写，可应用于计算机网络中树形拓扑结构建立，主要作用是防止网桥网络中的冗余链路形成环路工作。

## 背景
为了提高网络的可用性，需要进行冗余和备份。但是冗余路径会产生环路<br>
环路会导致以下问题

* 广播风暴：
    由于交换机会对广播、多播、和未知目标MAC的单播包进行泛洪，在存在环路的情况下，很短的时间内就会产生风暴
* 多帧拷贝、MAC地址表不稳定：
    当交换机刚刚启动时，MAC地址表是空的，所以，所有的单播帧都会进行泛洪操作。但是如果存在环路的话，交换机在特定情况下，会从不同的接口收到相同的MAC地址，这样的话，MAC地址表将不稳定

## 解决原理

STP(IEEE802.1D)就是通过 `软件` 防止环路的产生，通过 `逻辑的` 禁用接口，使得环路在逻辑上不存在；<br>
当线路出现故障时，将禁用的接口启用，使得网络能够发挥物理冗余路径带来的高可用性.

## STP协议的工作原理

### STP协议的原则如下：
1. 每个广播域中只有一个根网桥，根网桥的接口都是指定接口
2. 每一个非根网桥上都有一个根接口，根接口就是到达根网桥最近(带宽最高，开销最小)的接口
3. 每个网段中只有一个指定接口(发送方的桥ID较小的，或者端口优先级较小，或者端口ID较小的)
4. 非指定接口不使用

### 生成树协议的基本原理

基本思想：在网桥之间传递特殊的消息(配置信息)，包含足够的信息做以下工作：

- 从网络中的所有网桥中，选出一个作为根网(Root)
- 计算本网桥到根网桥的最短路径
- 对每个LAN，选出离根桥最近的那个网桥作为指定网桥，负责所在LAN上的数据转发
- 网桥选择一个根端口，该端口给出的路径是此网桥到根桥的最佳路径
- 选择除根端口之外的包含于生成树上的端口(指定端口)

生成树算法的基本原理很简单，网桥之间彼此传递一种特殊的配置消息，802.1D协议将这种配置消息称为“配置桥协议数据单元”或者“`配置BPDU`”。交换机会根据BPDU消息完成如下工作：
1. 在桥接网络的所有参与生成树计算的网桥中，选出一个作为树根(Root Bridge)
2. 计算出其他网桥到这个根网桥的最短路径；
3. 为每一个LAN选出一个指定网桥，该网桥必须是离根网桥最近的，指定网桥负责将这个LAN上的包转发给根桥；
4. 为每个网桥选择一个根端口，该端口给出的路径是本网桥到根网桥的最短路径；
5. 选择包含在生成树上的端口，由根端口和LAN连接其指定网桥的那些端口(指定端口)组成。

### 配置消息介绍

配置消息也被称为桥协议数据单元(BPDU)，它主要包括以下内容：即桥接网络中的根桥ID，从指定网桥到根网桥的最小路径开销，指定网桥ID和指定端口ID四项内容。网桥之间通过传递这些内容就足以能够完成生成树的计算，为了叙述方便，可以用矢量形式(RootID，RootPathCost，DesignatedBridgeID，DesignatedPortID)来描述某个网桥所发出的BPDU内容。

最初，所有的网桥都发送以自己为根桥的配置消息，比如网桥B发送的配置消息为(B，0，B，PortID)；网桥将接收到的配置消息和自己的配置消息进行优先级比较，保留优先级较高的配置消息，并据此完成生成树的计算。

桥接网络中，每个网桥都有一个用来标识自己的唯一的48位地址，生成树协议中，使用网桥优先级和该48位地址的组合作为网桥的ID在配置消息的数据部分中来表示这个网桥。对每个网桥来说，这个网桥的所有端口可以使用端口优先级和端口索引值作为ID来表示，生成树协议使用这个ID在配置消息中唯一的表示网桥中的某个特定端口。

DMA|SMA|L/T|LLC Header|Payload
-|-|-|-|-
目的MAC地址|源MAC地址|帧长|固定的链路头|BPDU数据

BPDU配置消息是以以太网数据帧的格式进行传递的，它采用一个周知的多播MAC地址01-80-C2-00-00-00作为目的MAC地址，网络中所有的网桥接收到改地址后都能够判断出该报文是生成树协议的协议报文，源MAC地址域中填的是本网桥的MAC地址。数据链路层报头中的SAP值是0 1 0 0 0 0 1 0（0x42）。

在报文的数据域中携带了用于生成树计算的所有数据，他除了上面说提到的根桥ID，到根桥的最小路径费用，指定桥ID和指定端口ID外，还包含一些辅助信息的值。

### 生成树比较

#### 配置消息的处理

将各个端口收到的配置消息和自己的配置消息作比较，得出优先级最高的配置消息更新本身的配置消息，主要工作有：
- 选择根网桥RootID，最优配置消息的RootID
- 计算到根桥的最短路径开销RootPathCost：如果自己是根桥，则对端路径开销为0，否则为它所收到的最优配置消息的RootPathCost与收到该配置消息的端口开销之和
- 选择根端口RootPort，如果自己是根桥，则根端口为0，否则根端口为收到最优配置消息的那个端口
- 择指定端口，包括在生成树上处于转发状态的其他端口
从指定端口发送新的配置消息

如何根据优先级比较的结果计算生成树呢？主要分成如下的几个步骤：
1. 首先，配置消息中最小的那个根网桥ID将成为生成树的根；
2. 如果自己就是根网桥，则最短路径开销为0；否则将最有配置消息中的路径开销加上接收端口对应链路的路径开销就是本网桥到根的最短路径开销；
3. 然后选择根端口，一般来说对应最短路径开销的那个端口就是根端口，但是如果对应对端路径开销的端口不止一个，则ID号最小的端口将成为根端口；
4. 确定根和最短路径之后，网桥得到自己的配置消息，并将自己作为接收到的配置消息比之劣的那些端口的指定网桥，而这些端口就是指定端口。
5. 最后，网桥从指定端口将自己的配置消息发送出去。

#### 如何确定最优的配置消息

配置消息的优先级比较原则：

假定有两条配置消息C1和C2，则：

- 如果C1的RootId小于C2的RootID，则C1优于C2
- 如果C1和C2的RootID相同，但C1的RootPathCost小于C2，则C1优于C2
- 如果C1和C2的RootID和RootPathCost相同，但C1的transmitID小于C2，则C1优于C2
- 如果C1和C2的RootID、RootPathCost和TransimitID相同，但C1的PortID小于C2，则C1优于C2

配置消息优先级比较明原则是：

●  先比较根网桥的ID，数值较小的那个优先级较高；
●  如果根网桥ID相同，则比较发送网桥到根桥的最短路径，数值较小的优先级较高；
●  如果前两者都相同，则比较发送网桥的ID，数值较小的优先级较高
●  最后如果前三者都相同，则比较发送端口ID(即配置消息中的指定端口的ID)，同样是数值较小的优先级较高